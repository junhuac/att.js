<html>
    <head>
        <link href="css/alu-webrtc.css" rel="stylesheet">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
        <script src="../src/att.js"></script>
        <script src="../src/att.me.alu.js"></script>
        <script src="../src/att.phonenumber.js"></script>
        <script src="../vendor/alu/orca.js"></script>
        <script src="../vendor/alu/orcaALU.js"></script>
        <script src="../vendor/alu/sip.js"></script>
        <script src="../vendor/alu/att.phone.alu.js"></script>

        <script type="text/javascript">
            $(document).ready(function() {

//                var oauthParams = {},
//                        queryString = window.parent.location.hash.substring(1),
//                        regex = /([^&=]+)=([^&]*)/g,
//                        m,
//                        html = '';
//
//                while (m = regex.exec(queryString)) {
//                    oauthParams[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
//                }
//
//                var access_token = oauthParams['access_token'];

                var opts = {settings: {
                                userid: "sip:+14047241223@foundry.att.com",
                                token: {id: "4047241223@private.att.net", key: "1223pla"}
                            },
                            "access_token" : "one"
                };
                
                var access_token = "one";
                
                startCall(opts);
                function startCall(opts) {
                    WildEmitter.call(this);

                    $('.call0 .hangup').hide();
                    $('.call0 .answer').hide();

                    if (access_token) {
                        $('.call0 .login').hide();

                    } else {
                        $('.call0 .call').hide();
                    }

                    var att = new ATT(opts);

                    var thecall = null;

                    att.on('*', function(eventName, payload) {
                        console.debug("received ATT event: " + eventName);
                        console.debug("event payload: " + payload);

                        if (eventName === 'ready') {
                            onReady(payload)
                        }
                        else if (eventName === 'calling') {
                            onCalling(payload)
                        }
                        else if (eventName === 'ring') {
                            onRing(payload)
                        }
                        else if (eventName === 'callBegin') {
                            onCallBegin(payload)
                        }
                        else if (eventName === 'callEnd') {
                            onCallEnd(payload)
                        }
                        else if (eventName === 'hold') {
                            onHold(payload)
                        }
                        else if (eventName === 'retrieve') {
                            onRetrieve(payload)
                        }
                        else if (eventName === 'waiting') {
                            onWaiting(payload)
                        }
                        else if (eventName === 'unready') {
                            onUnReady(payload)
                        }
                        else if (eventName === 'outgoingCall') {
                            onOutgoingCall(payload)
                        }
                        else if (eventName === 'incomingCall') {
                            onIncomingCall(payload)
                        }
                        else if (eventName === 'error') {
                            onError(payload)
                        }
                        else {
                            console.error('Received an unknown event from ATT (' + eventName + ')')
                        }
                        ;
                    });

                    var onReady = function(payload) {
                        console.warn("onReady() not defined")
                    }

                    var onCalling = function(call) {
                        $('.call0 .call').hide();
                        $('.call0 .hangup').show();
                        $('.call0 .answer').hide();
                    }

                    var onRing = function(payload) {
                        console.warn("onRing() not defined")
                    }

                    var onCallBegin = function(call) {
                        if (call.remoteMediaStream) {
                            var url = webkitURL.createObjectURL(call.remoteMediaStream);
                            $('.call0 .remoteVideo').attr('src', url);
                        }

                        $('.call0 .answer').hide();
                    }

                    var onCallEnd = function(call) {
                        console.log("onCallEnd()");

                        $('.call0 .call').show();
                        $('.call0 .hangup').hide();
                        $('.call0 .answer').hide();
                        $('.call0 .remoteVideo').attr('src', '');
                    }

                    var onHold = function(payload) {
                        console.warn("onHold() not defined")
                    }

                    var onRetrieve = function(payload) {
                        console.warn("onRetrieve() not defined")
                    }

                    var onWaiting = function(payload) {
                        console.warn("onWaiting() not defined")
                    }

                    var onUnReady = function(payload) {
                        console.warn("onUnReady() not defined")
                    }

                    var onOutgoingCall = function(call) {
                        console.log("onOutgoingCall()");
                        thecall = call;

                        if (call.localMediaStream) {
                            var url = webkitURL.createObjectURL(call.localMediaStream);
                            $('.call0 .localVideo').attr('src', url);
                        }
                    }

                    var onIncomingCall = function(call, phonenumber) {
                        console.log("onIncomingCall()");
                        thecall = call;

                        if (call.localMediaStream) {
                            var url = webkitURL.createObjectURL(call.localMediaStream);
                            $('.call0 .localVideo').attr('src', url);
                        }

                        $('.call0 .call').hide();
                        $('.call0 .hangup').show();
                        $('.call0 .answer').show();
                        $('.call0 .call_to').hide();

                    }

                    var onError = function(payload) {
                        console.log("onError()");

                        $('.call0 .call').show();
                        $('.call0 .hangup').hide();
                        $('.call0 .answer').hide();
                        $(".call0 .localVideo").attr('src', '');
                    }

                    $('.call0 .call').click(function() {
                        var callee = $('.call0 .call_to').val();
                        var pub_id = "sip:+1" + callee + "@foundry.att.com";
                        att.dial(pub_id);
                    });

                    $('.call0 .hangup').click(function() {
                        if (thecall) {
                            thecall.hangup();
                        }
                    });

                    $('.call0 .answer').click(function() {
                        if (thecall) {
                            thecall.answer();
                        }
                    });

                    $('.call0 .login').click(function() {
                        window.location.href = "https://auth.tfoundry.com/oauth/authorize?client_id=ulhnzsveuiijkdmm3v6lj5dm2khh4hk7&response_type=token&scope=profile,webrtc&redirect_uri=http://work.localhost/att.js-kamal/att.js/examples/aluphone.html";
                    });
                }

            });
        </script>
    </head>
    <body>

        <div id="webrtc-container">
            <!-- video call windows-->  
            <div class="webrtc-row">
                <div class="span8">
                    <div class="videoContainer call0" style="height: 400px; width: 400px;">
                        <video class="remoteVideo" style="height: 400px; width: 400px;" autoplay="autoplay" src=""></video>
                    </div>
                    <!-- video call navigation-->  
                    <div class="call0 numberBox">
                        <input type="text" class="call_to" placeholder="e.g. 5552223333">  
                    </div>
                    <div class="wrtc-buttons call0">
                        <p class="status"></p>
                        <input type="button" class="wrtc-button login" value="Login"/>
                        <input type="button" class="wrtc-button call" value="Call"/>
                        <input type="button" class="wrtc-button hangup" value="Hangup"/>
                        <input type="button" class="wrtc-button answer" value="Answer"/>
                    </div>  
                    <!--end video call nav-->
                </div>

                <div class="span4">
                    <div>
                        <div class="videoContainer call0">
                            <video class="localVideo" style="height: 130px; width: 130px;" autoplay="autoplay" src=""></video>
                        </div>
                    </div>

                    <div class="call0">
                        <p class="status"></p>
                    </div>
                </div>
            </div>  
        </div>



        <div class="contaner">
            <div class="row">
                <div class="span8 offset2">

                </div>
            </div>
        </div>
    </body>
</html>